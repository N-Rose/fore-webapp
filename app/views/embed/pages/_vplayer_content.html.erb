<%= Gon::Base.render_data %>
<div class="hole-bar">
  <ul >
    <li id="firstli" ><text id="hole">0</text>&nbsp;<span id="hole-num">0</span></li>
    <li ><span>PAR</span>&nbsp;&nbsp;<text id="par">0</text></li>
    <li ><text id="yard">0</text>&nbsp;&nbsp;<span>YDS</span></li>
    <li id="lastli" ><text id="mhcp">0</text>&nbsp;<span>HCP</span></li>
    <!-- <li style="padding:0;" ><text id="mhcp"></text><span></span> </li> -->
  </ul>
</div>
<video id="hole-vid" class="video-js vjs-default-skin vjs-big-play-centered video_container" playsinline></video>
<div class="previous on-video"> <%= image_tag "left.png" %> </div>
<div class="next on-video"><%= image_tag "right.png" %></div>
<div class="logo on-video"><%= link_to image_tag(logo_on_video(@course)), hyperlink_on_video(@course), target: :_blank %></div>
<div class = "lower-gradient"></div>
<div class="vjs-playlist">
  <div id="0" class="hole-home active">
    <%= link_to "javascript:void(0);" do %>
      <%= image_tag('hole-home.png') %>
    <% end %>
  </div>
  <div class="left-green"><!-- <i class="fa fa-chevron-left" aria-hidden="true"  style="color:<%=color_selector(@course.color_selector)%>"></i> -->
   <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
     width="19px" viewBox="0 0 15.225 26.936" enable-background="new 0 0 15.225 26.936" xml:space="preserve" style="margin-top:8px;">
   <path fill-rule="evenodd" clip-rule="evenodd" fill="<%=color_selector(@course.color_selector)%>" d="M12.664,0.439c0.586-0.586,1.535-0.586,2.121,0
    c0.585,0.585,0.585,1.535,0,2.121L3.62,13.725l10.651,10.65c0.586,0.586,0.586,1.536,0,2.121c-0.586,0.586-1.535,0.586-2.121,0
    L0.439,14.785c-0.586-0.586-0.586-1.535,0-2.121L12.664,0.439z"/>
   </svg>
  </div>
  <div  class="playlist">
    <ul id="playlist" >
      <% @holes.try(:each) do |hole| %>
        <li id="<%=hole.hole_num%>" class= "hole-number" hole_image= "<%= hole.logo_image.present? ? hole.logo_image.url : logo_on_video(@course)%>" logo_hyperlink = "<%= hole.logo_hyperlink.present? ? hole.logo_hyperlink : hyperlink_on_video(@course)%>" color="<%=color_selector(@course.color_selector)%>" onClick="select_video(this.id,this.color);ga('send','event','videos','Play',this.id);">
          <%=link_to hole.hole_num, embed_hole_info_path(hole.id, hole_num: hole.hole_num), remote: true %>
        </li>
      <% end %>
    </ul>
  </div>
  <div class="right-green">
    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
       width="19px" viewBox="0 0 15.225 26.936" enable-background="new 0 0 15.225 26.936" xml:space="preserve" style="margin-top:8px;">
      <path fill-rule="evenodd" clip-rule="evenodd" fill="<%=color_selector(@course.color_selector)%>" d="M2.561,0.439c-0.586-0.586-1.535-0.586-2.121,0
      c-0.585,0.585-0.585,1.535,0,2.121l11.165,11.164L0.953,24.375c-0.586,0.586-0.586,1.536,0,2.121c0.586,0.586,1.535,0.586,2.121,0
      l11.711-11.711c0.586-0.586,0.586-1.535,0-2.121L2.561,0.439z"/>
    </svg>
  </div>
</div>
<script type="text/javascript">
  $(document).ready(function() {
    var videoList = [];
    for (var i = 0, len = gon.videos_urls.length; i < len; i++) {
      videoList.push({
        sources: [{
          src: gon.videos_urls[i],
          type: "video/mp4"
        }],
        poster: gon.image_urls[i]
      });
    }

    //alert(videoList.first.sources.src);
    var player = videojs('hole-vid', {
      controls: true, fluid:true,
      'playbackRates': [0.5, 1, 1.5, 2],
      abr: {enable: true},
      controlBar: {
        children: {
          'playToggle':{},
          'progressControl':{},
          'volumeMenuButton':{},
          'volumePanel': {inline: false},
          'playbackRateMenuButton':{},
          'fullscreenToggle':{}
        }
      }
    });

    try {player.volume(1);} catch (e) {}
    player.playlist(videoList);
    player.playlist.autoadvance(0);
    if (player.playlist().length == 1){
      $('.on-video.previous').hide();
      $('.on-video.next').hide();
    }
    $('.player-container').hover(
      function(event){
        bgcolor = $(this).attr('progress-color');
        showBars();
        progressColor(bgcolor);
      }, function(){
        player = videojs('hole-vid');
        if ((player != null) && (!(player.paused()))){
          hideBars();
          player.userActive(false);
        }
      }
    );
    player.on("loadedmetadata",function () {
      barupdate();
      current_video();
      if($(window).width() < 760 && ((player != null) && (!player.paused()))){
        showPlayerActions();
      }else{
        showBars();
      }
      timer = setTimeout(function(){hideBars()}, 1000);
    });

    player.on("userinactive",function () {
      if ((player != null) && (!player.paused())){
        hideBars();
      }
    });
    player.on("useractive",function () {
      showBars();
      clearTimeout(timer);
    });
    xx = $(".vjs-playlist").outerHeight();
    xx-=2;
    $(".lower-gradient").css({bottom: xx+'px'});
    $firstElement = 0;
    document.querySelector('.right-green').addEventListener('click', function() {
      var nextActiveId;
      if($(window).width() < 350){
        nextActiveId = $firstElement + 1;
      }
      else if($(window).width() >= 350 && $(window).width() < 480){
        nextActiveId = $firstElement + 2;
      }
      else if($(window).width() >= 480 && $(window).width() < 600){
        nextActiveId = $firstElement + 3;
      }
      else if($(window).width() >= 600 && $(window).width() < 760){
        nextActiveId = $firstElement + 5;
      }
      else if($(window).width() >= 760 && $(window).width() < 960){
        nextActiveId = $firstElement + 6;
      }
      else if($(window).width() >= 960 && $(window).width() < 1200){
        nextActiveId = $firstElement + 9;
      }
      else if($(window).width() >= 1200){
        nextActiveId = $firstElement + 10;
      }
      if(nextActiveId == 0 || $("#playlist").find("#"+nextActiveId).size() != 0){
        scrollTo(nextActiveId);
        $firstElement = nextActiveId
      }
    });
    document.querySelector('.left-green').addEventListener('click', function() {
      var nextActiveId;
      if($(window).width() < 350){
        nextActiveId = $firstElement - 1;
      }
      else if($(window).width() >= 350 && $(window).width() < 480){
        nextActiveId = $firstElement - 2;
      }
      else if($(window).width() >= 480 && $(window).width() < 600){
        nextActiveId = $firstElement - 3;
      }
      else if($(window).width() >= 600 && $(window).width() < 760){
        nextActiveId = $firstElement - 5;
      }
      else if($(window).width() >= 760 && $(window).width() < 960){
        nextActiveId = $firstElement - 6;
      }
      else if($(window).width() >= 960 && $(window).width() < 1200){
        nextActiveId = $firstElement - 9;
      }
      else if($(window).width() >= 1200){
        nextActiveId = $firstElement - 10;
      }
      if (nextActiveId < 0){
        nextActiveId = 0
      }
      if(nextActiveId == 0 || $("#playlist").find("#"+nextActiveId).size() != 0){
        scrollTo(nextActiveId);
        $firstElement = nextActiveId
      }
    });
    $('.vjs-volume-panel').removeClass('vjs-hidden')
    $('.vjs-mute-control').removeClass('vjs-hidden')
    $('.vjs-volume-control').removeClass('vjs-hidden')
        /* ADD flag */
    var flagLength = $('.flag').length;
    if (flagLength == 0){
      var Button = videojs.getComponent('Button');

      var FlagButton = videojs.extend(Button, {
        constructor: function() {
          Button.apply(this, arguments);
          this.addClass('flag');
          this.controlText("Flag");
        },

        handleClick: function() {
          flag_control();
        }
      });

      // Register the new component
      videojs.registerComponent('FlagButton', FlagButton);
      player.getChild('controlBar').addChild('FlagButton', {}, 3);
    }

    $(".hole-home").on("click touchend", function(e) {
      select_video(this.id);
      $.ajax({
        url: '<%= embed_course_info_path(@course.id) %>',
        type: 'GET',
        dataType: "script"
      })
    });
    $(".hole-number").click(function(){
      logoImage = $(this).attr('hole_image');
      logoHyperlink = $(this).attr('logo_hyperlink');
      $('.logo a img').attr('src', logoImage)
      $('.logo a').attr('href', logoHyperlink)
    });
  });
  function select_video(id){
    if (id==='0'){
      $('.active').removeClass("active");
      $('#0').addClass("active");
    }
    else{
      $('.active').removeClass("active");
      $('#'+id).addClass("active");
    }
  }
  function flag_control(){
    for (var i = 0, len = gon.videos.length; i < len; i++) {
      if (gon.tags[i].length > 0) {
        if (player.currentSrc().includes(gon.videos[i].video_file_name) && gon.videos[i].id == gon.tags[i][0].video_id) {
          player.currentTime(gon.tags[i][0].time);
        }
      }
    }
  }


  var timer;




  function hideBars(){
      $(".logo").fadeOut();
      $(".previous").fadeOut();
      $(".next").fadeOut();
      $(".hole-bar").fadeOut();
  }

  function showBars(){
    $(".hole-bar").fadeIn();
    showPlayerActions();
  }

  function progressColor(color){
   $('.vjs-play-progress').css({"background-color":color});
   $('.vjs-play-progress').css({"color":color});
   $('.video-js .vjs-volume-level').css({"background-color":color})
  }

  function showPlayerActions(){
    $(".logo").fadeIn();
    $(".previous").fadeIn();
    $(".next").fadeIn();
  }



  function playlistui(){
      for (var i = 1, len = 19; i < len; i++) {
        document.getElementById('playlist').innerHTML += '<li id="'+i+'" onClick="select_video(this.id)">'+i+'</li>';
      }
  }

  function barupdate(){
    var hole = player.playlist.currentItem();

    document.getElementById('hole').innerHTML = leftPad(hole+1,1);
    document.getElementById('hole-num').innerHTML = pos(hole+1);
    document.getElementById('par').innerHTML = leftPad(gon.par[hole],1);
    document.getElementById('yard').innerHTML = leftPad(gon.yard[hole],1);
    document.getElementById('mhcp').innerHTML = leftPad(gon.mhcp[hole],1);

  }

  function leftPad(number, targetLength) {
      var output = number + '';
      while (output.length < targetLength) {
          output = '0' + output;
      }
      return output;
  }

  function pos(num){
    switch (num) {
      default:
          return "TH";
          break;
      case 1:
          return "ST";
          break;
      case 2:
          return "ND";
          break;
      case 3:
          return "RD";
    }
  }
  function scrollTo(a){
    liWidth = $(".playlist ul li").outerWidth(true);
    scrollValue = a*liWidth;
    $('.playlist').animate( { scrollLeft: scrollValue }, 500);

  }

  function current_video(){
    $firstElement = 0;
    $('#0').removeClass("active");
    id = player.playlist.currentItem();
    for (i=0;i<18;i++){
      if (i===id){
        document.getElementById(i+1).className = "active";
        bgColor=document.getElementById(i+1).getAttribute('color')
        document.getElementById(i+1).setAttribute("style", "border-bottom: 4px solid "+ bgColor + " ");
        j=i+1;
        $('#'+j+' a').trigger('click');
        scrollTo(i);
      }
      else{
        document.getElementById(i+1).removeAttribute("class");
        document.getElementById(i+1).removeAttribute("style");
      }
    }
  }
</script>
